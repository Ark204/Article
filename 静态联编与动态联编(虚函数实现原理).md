# 静态联编与动态联编(虚函数实现原理)
## C++多态概念
多态字面意思就是多种状态
我们先来想一想在日常生活中的多态例子：买票时，成人买票全价，如果是学生那么半价，如果是军人，就可以优先买票。不同的人买票会有不同的实现方法，这就是多态

## 呈现
1. 必须通过**基类**的指针/引用调用**虚函数**
2. 被调用虚函数**被重写**

**总结**：使用**基类指针/引用**却可呈现**子类特性**

## 实现方式
**动态联编**：虚函数表+虚函数表指针
## 静态联编

**函数名联编**：将源代码中的函数调用解释为执行对应函数代码，完成于编译过程
**静态联编**：在函数名联编的基础上，补充C++对**重载**的函数解释——根据函数名+形参列表解释对应函数代码，完成于编译过程

补充：类函数的函数名全称：Class::Fun()

## 动态联编(虚函数实现原理)
单继承链中**第一个定义虚函数**的类，**会且只会**在其对象中**添加**一个额外成员——虚函数表指针->虚函数表
如B类继承自A类，A类中没有定义虚函数，B类中开始定义虚函数
```C++
class A
{
 int Afield;
}
class B:public A
{
 int Bfield;
 public:
 virtual void v();//在B类中首次定义虚函数
}
```

| 变量名 | var |备注 |
| :----: | :----: | :----: |
| Afield | ... |A类部分
| Bfield | ... |B类部分
| vptr(虚函数表指针) | B虚函数表地址 |额外在B类中添加的成员

在此基础上，若类C继承B类，则C类对象内存为：
| 变量名 | var |备注 |
| :----: | :----: | :----: |
| Afield | ... |A类部分
| Bfield | ... |B类部分
| vptr(虚函数表指针) | **C虚函数表地址** |额外在B类中添加的成员
| Cfield | ... |C类部分

除了添加了C类部分成员，还有<u>修改了vptr，让其指向C类虚函数表</u>
**总结**：无论是继续继承C类或让另一个类继承B类(父类中存在虚函数)，都会为新类**生成**新虚函数表，并在该类对象生成时，让vptr指向对应虚函数表

### 虚函数表生成
生成时间：编译过程
生成：若父类有虚函数表，则拷贝一份
重写：更新本虚函数表中对应函数地址
新定义：在本虚函数表末尾Add新函数地址
表中函数index=虚函数声明index

### 多继承时
1. 拷贝并添加n份直接父类的虚函数表(n=直接父类数)
2. 重写时更新对应的虚函数表中对应函数地址
3. 新定义时在**第一份**虚函数表末尾Add新函数地址

### 虚函数调用
1. 查看虚函数表地址，转到虚函数表位置
2. 执行对应函数
- **注意**：仅使用[指针/引用]调用虚函数时会使用动态联编(查虚函数表)，使用对象调用则不会—直接调用该对象版本

### 性能消耗
1. 对象增大
2. 每个类都要生成虚函数表
3. 每个函数调用都要**额外**到表中查地址

### 虚函数协变
1. 返回值是**指针/引用**
2. **重写**时返回的类型是**原返回类型的子类**

例：
```C++
class A{};
class B:public A{};
class Father{
  virtual A* GetPtr(){return new A();}
};
class Child{
  virtual B* GetPtr()override{return new B();}//重写父类的GetPtr()
}
```

### C++11 override与final
#### final后置修饰
**后置修饰函数**：<code>virtual void Fun()**final**{}</code>
表示函数无法被重写
**后置修饰类**：<code>class A **final**{}</code>
表示类无法被继承
#### override后置修饰
**后置修饰函数**：<code>virtual void Fun()**override**{}</code>
确保函数从父类某个虚函数重写，否则(父类中不含该虚函数)则报错

### 区分：重载，覆盖/重写，重定义（隐藏）
1. 重载：重载函数处在同一作用域。函数名相同，**函数列表不同**
2. 覆盖/重写：必须是虚函数，且处在父类和子类中。返回值，参数列表，函数名必须完全相同（协变除外）
3. 重定义：子类隐藏父类的对应变量/函数

## 两者对比
静态联编(用于非虚函数)
1. 效率高
2. 指出不用重写/覆盖该函数

动态联编(用于虚函数)
1. 支持重写
